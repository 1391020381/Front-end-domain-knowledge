* 在流媒体处理中,接受帧和解码帧的计算可以帮助我们了解数据的处理速度和性能。
* 这涉及到从WebSocket接受到 数据帧 并 将数据帧 解码并显示到视频元素中的过程。

* 帧率(Frame Rate) 通常指在一秒钟接受或处理的数据帧数,常用单位是帧每秒(Frame Per Second FPS)。帧率是衡量视频流和解码性能的一个重要的指标。

# 接受帧的计算
* 接受帧的计算主要涉及通过WebSocket接收的原始媒体数据帧。
    1. 计算接受帧： 每当通过 WebSocket接受到一帧数据时,递增接收帧计数器
    2. 记录接收时间 记录没一帧接收的时间戳

```

let receivedFrameCount = 0;
let receivedFrameTimestamps = [];

const webSocket = new WebSocket('wss://yourserver.com');
webSocket.binaryType = 'arraybuffer';

webSocket.onmessage = (event) => {
    receivedFrameCount++;
    receivedFrameTimestamps.push(Date.now());
    // 处理接收到的数据，例如追加到 SourceBuffer
    if (!sourceBuffer.updating && mediaSource.readyState === 'open') {
        sourceBuffer.appendBuffer(event.data);
    }
};


```


# 解码帧的计算
* 解码帧的计算主要涉及将数据帧从SourceBuffer解码并显示在 <video>元素中的过程。
    1. 计数解码的帧  每当 SourceBuffer 解码并完成更新时(即 updateend 事件触发时) 递增解码帧计数器
    2. 记录解码时间  记录每帧数据解码完成的时间戳。

```

let decodedFrameCount = 0;
let decodedFrameTimestamps = [];

mediaSource.addEventListener('sourceopen', () => {
    const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="hvc1.1.6.L93.B0"');

    sourceBuffer.addEventListener('updateend', () => {
        decodedFrameCount++;
        decodedFrameTimestamps.push(Date.now());
        // 清理缓冲区
        cleanUpBuffer(sourceBuffer);
    });

    // 假定有一个 WebSocket 连接接收数据
    webSocket.onmessage = (event) => {
        if (!sourceBuffer.updating && mediaSource.readyState === 'open') {
            sourceBuffer.appendBuffer(event.data);
        }
    };
});

```

# 计算帧率
* 根据时间戳来计算

```
function calculateFrameRate(frameTimestamps) {
    const timePeriod = 1000; // 计算 1 秒内的帧率
    const now = Date.now();
    const recentFrames = frameTimestamps.filter(timestamp => now - timestamp <= timePeriod);
    return recentFrames.length;
}


```

# 码率计算
* 码率 = 总数据量(比特) / 时间段 秒


```

let totalReceivedBytes = 0; // 总接收到的字节数
let startTime = Date.now(); // 开始时间

// WebSocket 接收数据事件
const webSocket = new WebSocket('wss://yourserver.com');
webSocket.binaryType = 'arraybuffer';

webSocket.onmessage = (event) => {
    totalReceivedBytes += event.data.byteLength; // 累加接收到的字节数
};

// 计算码率
function calculateBitrate() {
    const now = Date.now();
    const elapsedTime = (now - startTime) / 1000; // 已过去的时间（秒）
    const totalReceivedBits = totalReceivedBytes * 8; // 转换为比特   一个字节  8 比特
    const bitrate = totalReceivedBits / elapsedTime; // 计算码率 (bps)

    console.log(`Bitrate: ${bitrate.toFixed(2)} bps`);

    // 重置计数器和时间
    totalReceivedBytes = 0;
    startTime = now;
}

// 定期计算码率，例如每秒计算一次
setInterval(calculateBitrate, 1000);


```