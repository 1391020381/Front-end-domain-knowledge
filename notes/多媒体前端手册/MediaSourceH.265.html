<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediaSource H.265 Example</title>
  </head>
  <body>
    <video id="video" controls></video>

    <script>
      const mediaSource = new MediaSource();
      const video = document.querySelector("video");
      video.src = URL.createObjectURL(mediaSource);

      mediaSource.addEventListener("sourceopen", () => {
        const sourceBuffer = mediaSource.addSourceBuffer(
          'video/mp4; codecs="hvc1.1.6.L93.B0"'
        );

        sourceBuffer.addEventListener("updateend", () => {
          cleanUpBuffer(sourceBuffer);
        });

        // WebSocket 连接示例
        const webSocket = new WebSocket("wss://yourserver.com");
        webSocket.binaryType = "arraybuffer";

        webSocket.onmessage = (event) => {
          if (!sourceBuffer.updating && mediaSource.readyState === "open") {
            sourceBuffer.appendBuffer(event.data);
          }
        };
      });

      function cleanUpBuffer(sourceBuffer) {
        const buffered = sourceBuffer.buffered;
        const maxBufferLength = 30; // 保持缓冲不超过30秒

        if (buffered.length > 0) {
          const currentTime = video.currentTime;
          const start = buffered.start(0);
          const end = buffered.end(buffered.length - 1);

          // 如果缓冲区长度超过 maxBufferLength 或者当前播放时间离缓冲起始时间超过 maxBufferLength，就清理旧数据
          if (
            end - start > maxBufferLength ||
            currentTime - start > maxBufferLength
          ) {
            const removeEnd = Math.min(currentTime - 10, end - maxBufferLength);
            if (removeEnd > start) {
              sourceBuffer.remove(start, removeEnd);
              console.log(`Removed buffer from ${start} to ${removeEnd}`);
            }
          }
        }
      }

      // 定期检查并清理缓冲区
      const CLEANUP_INTERVAL = 10000; // 每10秒清理一次
      setInterval(() => {
        const sourceBuffers = mediaSource.sourceBuffers;
        for (let i = 0; i < sourceBuffers.length; i++) {
          cleanUpBuffer(sourceBuffers[i]);
        }
      }, CLEANUP_INTERVAL);
    </script>
  </body>
</html>
